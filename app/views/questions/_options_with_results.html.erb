<div id="voting-section">
  <% user_voted_on_this_question = current_user&.voted_on_question?(question) %>

  <% if user_voted_on_this_question %>
    <%# --- 投票済みのユーザー向け表示（結果を表示） --- %>
    <div class="space-y-6">
      <% question.options.each do |option| %>
        <% user_voted_on_this_option = current_user&.voted_for?(option) %>
        <% percentage = option.percentage_of_question_votes %>

        <div class="bg-gray-100 rounded-lg p-4 shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <span class="text-lg font-semibold text-gray-800"><%= option.content %></span>
            <span class="text-sm text-gray-600"><%= option.votes_count %>票 (<%= number_to_percentage(percentage, precision: 0) %>)</span>
          </div>

          <%# プログレスバーの表示 %>
          <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-6 mb-3">
            <div class="h-full rounded-full transition-all ease-out duration-[1500ms] bg-[linear-gradient(to_right,#48c6ef,#6f86d6)]" style="width: <%= percentage %>%;"></div>
          </div>

          <%# 投票ボタンの表示ロジック %>
          <% if user_voted_on_this_option %>
            <div class="flex justify-center">
              <%= button_to vote_path(current_user.votes.find_by(option: option)), method: :delete,
                            class: "py-2 px-4 rounded-lg bg-red-500 text-white font-semibold text-sm hover:bg-red-600 transition duration-200",
                            data: { turbo_frame: "voting-section", turbo_confirm: "投票をやり直しますか？" } do %>
                <span class="text-sm"><%= t('.re-vote')%></span>
              <% end %>
            </div>
          <% else %>
            <div class="flex justify-center">
              <button class="py-2 px-4 rounded-lg bg-gray-300 text-gray-600 font-semibold text-sm cursor-not-allowed" disabled>
                <%= t('.already_voted')%>
              </button>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="text-lg mb-2"><%= t('.choose')%></p>
    <% if current_user %>
      <div class="space-y-6">
        <% question.options.each do |option| %>
          <%= button_to question_votes_path(question, vote: { option_id: option.id }), method: :post,
                        class: "w-full h-12 py-2 px-6 rounded-lg bg-orange text-white font-semibold text-lg hover:bg-dark-orange transition duration-200",
                        data: { turbo_frame: "voting-section"} do %>
            <%= option.content %>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="space-y-6">
        <p class="text-center text-lg text-red-500 text-bold"><i class="fa-regular fa-circle-user mr-2"></i><%= t('.vote_login_prompt')%></p>
        <% question.options.each do |option| %>
          <div class="w-full h-12 py-2 px-6 rounded-lg bg-orange text-white font-semibold text-lg">
            <%= option.content %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% end %>
</div>